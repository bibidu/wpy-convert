function createLocalData(){var e=uuid(),t={version:config.localVersion,clientId:e,apps:{},debugApps:{},token:{},timeDown:0,timeUp:0,records:[]};return t}function saveApp(e,t,n){var o;try{o=wx.getStorageSync(config.storageKey)}catch(e){console.log(e)}o&&(n?o.debugApps[e]=t:(o.apps[e]=t,o.token=t.token,o.timeDown=t.timeDown));try{wx.setStorageSync(config.storageKey,o)}catch(e){console.log(e)}}function ajax(e,t,n){wx.request({url:e,data:t,method:"POST",header:{"content-type":"application/json;charset=UTF-8"},success:function(e){n&&n(null,e.data)},fail:function(e){console.log(e)}})}function getToken(e){function t(){var t=e._get("clientId"),n=t.substring(t.length-2);return parseInt(n)}function n(e,t){return"undefined"==typeof e?t:e}var o;try{o=wx.getStorageSync(config.storageKey)}catch(e){console.log(e)}var r=o.token||{},a=(new Date).getTime(),s={appKey:e._get("appKey"),userId:n(r.userId,0),state:n(r.state,"NEW"),threshold:n(r.threshold,100),hashCode:n(r.hashCode,t()),isGray:n(r.isGray,!1),isOnce:n(r.isOnce,!1),isDebug:!1,timeout:n(r.timeout,a),timestamp:n(r.timestamp,a),surviveAge:n(r.surviveAge,3),minExpTime:n(r.minExpTime,{})};return e._get("isDebug")&&(s.isDebug=!0,s.state="DEBUG"),s}function setUpAndDown(e){var t;try{t=wx.getStorageSync(config.storageKey)}catch(e){console.log(e)}var n=t.token,o=n.state||"NEW";switch(e._get("isDebug")&&(o="DEBUG"),o){case"NEW":e._set("sdkAllowUpload",!0),e._set("sdkAllowDownload",!0);break;case"DEBUG":e._set("sdkAllowUpload",!0),e._set("sdkAllowDownload",!0);break;case"TERMINATED":e._set("sdkAllowUpload",!1),e._set("sdkAllowDownload",!1);break;case"TIME_WAIT":e._set("sdkAllowUpload",!1),(new Date).getTime()>=n.timeout?e._set("sdkAllowDownload",!0):e._set("sdkAllowDownload",!1);break;case"WAITING":e._set("sdkAllowUpload",!1),n.isGray&&(new Date).getTime()-t.timeUp>=864e5&&e._set("sdkAllowUpload",!0),(new Date).getTime()-t.timeDown>=864e5?e._set("sdkAllowDownload",!0):e._set("sdkAllowDownload",!1);break;case"READY":e._set("sdkAllowUpload",!0),e._set("sdkAllowDownload",!0);break;case"RUNNING":e._set("sdkAllowUpload",!0),e._set("sdkAllowDownload",!0)}}function reqExp(e,t){function n(t){e._set("data",t),e._set("dataLoaded",!0);var n=e._get("varsData");if(t&&t.exps)for(var o=t.exps,r=0;r<o.length;r++)for(var a in o[r].componentsValues)n[a]=o[r].componentsValues[a];for(var s=e._get("getExperimentsCallback")||[],r=0;r<s.length;r++)s[r]();s.splice(0)}function o(){ajax(e._get("url")+config.expUrl,s,function(o,a){var s;o?sendErr(e,{msg:o.msg||o.message}):(0===a.errNo||10001===a.errNo||10003===a.errNo,a.data.timeDown=(new Date).getTime(),s=a.data,e._get("isDebug")?saveApp(e._get("expVersionId"),s,!0):saveApp(e._get("appKey"),s,!1)),r||o||(n(s),t(e._get("vars")))})}var r,a;try{a=wx.getStorageSync(config.storageKey)}catch(e){console.log(e)}a&&(r=e._get("isDebug")?a.debugApps[e._get("expVersionId")]:a.apps[e._get("appKey")],r&&(n(r),t(e._get("vars"))));var s={appKey:e._get("appKey"),clientId:e._get("clientId"),appVersion:env.appVersion,sdkVersion:config.sdkVersion,deviceinfo:{osVersionCode:"",osVersion:env.os.version,platform:env.os.name,packageName:config.packageName,language:env.language,country:env.country,deviceType:"",deviceModel:env.device.model,displayWidth:env.device.screenWidth,displayHeight:env.device.screenHeight,net:"",ip:""},expVersionId:"0",newPV:!0,token:getToken(e)},i=e._get("tags");if(i)for(var c in i)s.customerLabel=s.customerLabel||{},s.customerLabel[c]=i[c];e._get("isDebug")&&(s.expVersionId=e._get("expVersionId")),wx.getNetworkType({success:function(e){s.deviceinfo.net=e.networkType,o()},fail:function(){o()}})}function ajaxTrack(e,t,n){if(!e._get("localStorageSupported"))return void(n&&n(null));var o;try{o=wx.getStorageSync(config.storageKey),console.log(o)}catch(e){console.log(e)}o.records=o.records.concat(t);try{wx.setStorageSync(config.storageKey,o)}catch(e){console.log(e)}if(!e._get("sdkAllowUpload"))return void(n&&n(null));var r;o.records.length<config.maxUploadCount?(r=o.records,o.records=[]):r=o.records.splice(0,config.maxUploadCount),o.timeUp=(new Date).getTime();try{wx.setStorageSync(config.storageKey,o)}catch(e){console.log(e)}var a=parseInt((new Date).getTime()/1e3),s=e._get("appKey"),i={appKey:s,clientId:e._get("clientId"),stime:a,sign:md5(s+a).substring(0,6),debug:e._get("isDebug")?1:0,records:r};ajax(e._get("url")+config.trackUrl,i,function(e,t){n&&n(!e&&t&&0===t.errNo?null:new Error("ä¸ŠæŠ¥å¤±è´¥"))})}function reqPV(e,t){if(t.varName||t.opName){for(var n,o,r=e._get("data"),a=r&&r.exps||[],s=0;s<a.length;s++)if(a[s].isUpload)if(t.varName){for(var i in a[s].componentsValues)if(i==t.varName&&!e._get("versionPV")[a[s].componentsKey]){e._get("versionPV")[a[s].componentsKey]=!0,n=a[s].expId,o=a[s].componentsKey;break}}else for(var c=a[s].events,l=0;l<c.length;l++)if(c[l]===t.opName&&!e._get("versionPV")[a[s].componentsKey]){e._get("versionPV")[a[s].componentsKey]=!0,n=a[s].expId,o=a[s].componentsKey;break}n&&o&&ajaxTrack(e,[{expId:n,componentsKey:o,metrics:[{name:"PV",count:1,time:parseInt((new Date).getTime()/1e3)}]}])}}function reqTrack(e,t,n){function o(e,t){for(var n=0;n<i.length;n++)if(i[n].expId==e&&i[n].componentsKey==t)return i[n].metrics;return null}function r(e,t){for(var n=0;n<s.length;n++){var r=s[n].events;if(s[n].isUpload)for(var a=0;a<r.length;a++)if(r[a]===e){var c=o(s[n].expId,s[n].componentsKey);return void(c?c.push({name:e,count:t,time:parseInt((new Date).getTime()/1e3)}):i.push({expId:s[n].expId,componentsKey:s[n].componentsKey,metrics:[{name:e,count:t,time:parseInt((new Date).getTime()/1e3)}]}))}}}var a=e._get("data"),s=a&&a.exps||[],i=[];for(var c in t)r(c,t[c]);return i.length?void ajaxTrack(e,i,n):void(n&&n())}function sendErr(e,t){ajax(e._get("url")+config.errUrl,{appKey:e._get("appKey"),clientId:e._get("clientId"),appVersion:env.appVersion,sdkVersion:config.sdkVersion,from:"weapp",platform:env.os.name,platformVersion:env.os.version,model:env.device.model,records:JSON.stringify([{errorTime:parseInt((new Date).getTime()/1e3),errorData:t.msg}])},function(e,t){})}function ABTest(){var e=this,t={data:null,isCrawler:!1,appKey:"",clientId:"",isDebug:!1,expVersionId:void 0,defVars:{},varsData:{},versionPV:{},tags:null,timeout:3e3,minTimeout:1e3,url:config.url,dataLoaded:!1,sdkAllowUpload:!0,sdkAllowDownload:!0,getExperimentsCallback:[],localStorageSupported:!0,vars:{get:function(n,o){return o&&o.noPV||reqPV(e,{varName:n}),t.varsData[n]}}};if(!(this instanceof ABTest))throw new Error("å®žä¾‹åŒ–ABTesté”™è¯¯");this._get=function(e){return t[e]},this._set=function(e,n){t[e]=n}}var md5=function(e){"use strict";function t(e,t){var n=(65535&e)+(65535&t),o=(e>>16)+(t>>16)+(n>>16);return o<<16|65535&n}function n(e,t){return e<<t|e>>>32-t}function o(e,o,r,a,s,i){return t(n(t(t(o,e),t(a,i)),s),r)}function r(e,t,n,r,a,s,i){return o(t&n|~t&r,e,t,a,s,i)}function a(e,t,n,r,a,s,i){return o(t&r|n&~r,e,t,a,s,i)}function s(e,t,n,r,a,s,i){return o(t^n^r,e,t,a,s,i)}function i(e,t,n,r,a,s,i){return o(n^(t|~r),e,t,a,s,i)}function c(e,n){e[n>>5]|=128<<n%32,e[(n+64>>>9<<4)+14]=n;var o,c,l,g,p,u=1732584193,d=-271733879,f=-1732584194,v=271733878;for(o=0;o<e.length;o+=16)c=u,l=d,g=f,p=v,u=r(u,d,f,v,e[o],7,-680876936),v=r(v,u,d,f,e[o+1],12,-389564586),f=r(f,v,u,d,e[o+2],17,606105819),d=r(d,f,v,u,e[o+3],22,-1044525330),u=r(u,d,f,v,e[o+4],7,-176418897),v=r(v,u,d,f,e[o+5],12,1200080426),f=r(f,v,u,d,e[o+6],17,-1473231341),d=r(d,f,v,u,e[o+7],22,-45705983),u=r(u,d,f,v,e[o+8],7,1770035416),v=r(v,u,d,f,e[o+9],12,-1958414417),f=r(f,v,u,d,e[o+10],17,-42063),d=r(d,f,v,u,e[o+11],22,-1990404162),u=r(u,d,f,v,e[o+12],7,1804603682),v=r(v,u,d,f,e[o+13],12,-40341101),f=r(f,v,u,d,e[o+14],17,-1502002290),d=r(d,f,v,u,e[o+15],22,1236535329),u=a(u,d,f,v,e[o+1],5,-165796510),v=a(v,u,d,f,e[o+6],9,-1069501632),f=a(f,v,u,d,e[o+11],14,643717713),d=a(d,f,v,u,e[o],20,-373897302),u=a(u,d,f,v,e[o+5],5,-701558691),v=a(v,u,d,f,e[o+10],9,38016083),f=a(f,v,u,d,e[o+15],14,-660478335),d=a(d,f,v,u,e[o+4],20,-405537848),u=a(u,d,f,v,e[o+9],5,568446438),v=a(v,u,d,f,e[o+14],9,-1019803690),f=a(f,v,u,d,e[o+3],14,-187363961),d=a(d,f,v,u,e[o+8],20,1163531501),u=a(u,d,f,v,e[o+13],5,-1444681467),v=a(v,u,d,f,e[o+2],9,-51403784),f=a(f,v,u,d,e[o+7],14,1735328473),d=a(d,f,v,u,e[o+12],20,-1926607734),u=s(u,d,f,v,e[o+5],4,-378558),v=s(v,u,d,f,e[o+8],11,-2022574463),f=s(f,v,u,d,e[o+11],16,1839030562),d=s(d,f,v,u,e[o+14],23,-35309556),u=s(u,d,f,v,e[o+1],4,-1530992060),v=s(v,u,d,f,e[o+4],11,1272893353),f=s(f,v,u,d,e[o+7],16,-155497632),d=s(d,f,v,u,e[o+10],23,-1094730640),u=s(u,d,f,v,e[o+13],4,681279174),v=s(v,u,d,f,e[o],11,-358537222),f=s(f,v,u,d,e[o+3],16,-722521979),d=s(d,f,v,u,e[o+6],23,76029189),u=s(u,d,f,v,e[o+9],4,-640364487),v=s(v,u,d,f,e[o+12],11,-421815835),f=s(f,v,u,d,e[o+15],16,530742520),d=s(d,f,v,u,e[o+2],23,-995338651),u=i(u,d,f,v,e[o],6,-198630844),v=i(v,u,d,f,e[o+7],10,1126891415),f=i(f,v,u,d,e[o+14],15,-1416354905),d=i(d,f,v,u,e[o+5],21,-57434055),u=i(u,d,f,v,e[o+12],6,1700485571),v=i(v,u,d,f,e[o+3],10,-1894986606),f=i(f,v,u,d,e[o+10],15,-1051523),d=i(d,f,v,u,e[o+1],21,-2054922799),u=i(u,d,f,v,e[o+8],6,1873313359),v=i(v,u,d,f,e[o+15],10,-30611744),f=i(f,v,u,d,e[o+6],15,-1560198380),d=i(d,f,v,u,e[o+13],21,1309151649),u=i(u,d,f,v,e[o+4],6,-145523070),v=i(v,u,d,f,e[o+11],10,-1120210379),f=i(f,v,u,d,e[o+2],15,718787259),d=i(d,f,v,u,e[o+9],21,-343485551),u=t(u,c),d=t(d,l),f=t(f,g),v=t(v,p);return[u,d,f,v]}function l(e){var t,n="",o=32*e.length;for(t=0;t<o;t+=8)n+=String.fromCharCode(e[t>>5]>>>t%32&255);return n}function g(e){var t,n=[];for(n[(e.length>>2)-1]=void 0,t=0;t<n.length;t+=1)n[t]=0;var o=8*e.length;for(t=0;t<o;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return n}function p(e){return l(c(g(e),8*e.length))}function u(e,t){var n,o,r=g(e),a=[],s=[];for(a[15]=s[15]=void 0,r.length>16&&(r=c(r,8*e.length)),n=0;n<16;n+=1)a[n]=909522486^r[n],s[n]=1549556828^r[n];return o=c(a.concat(g(t)),512+8*t.length),l(c(s.concat(o),640))}function d(e){var t,n,o="0123456789abcdef",r="";for(n=0;n<e.length;n+=1)t=e.charCodeAt(n),r+=o.charAt(t>>>4&15)+o.charAt(15&t);return r}function f(e){return unescape(encodeURIComponent(e))}function v(e){return p(f(e))}function m(e){return d(v(e))}function h(e,t){return u(f(e),f(t))}function y(e,t){return d(h(e,t))}function w(e,t,n){return t?n?h(t,e):y(t,e):n?v(e):m(e)}return w}({}),uuid=function(){function e(){var e=(new Date).getTime();e%=16,e=e.toString(16);var t=Math.floor(65536*(1+Math.random())).toString(16).substring(1),n=parseInt(4*Math.random()),o=t.split("");return o[n]=e,o.join("")}var t=""+(new Date).getTime();return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+t.substring(1)},config,env;!function(){config={storageKey:"testinABWeAppStorage",localVersion:"v1.0.3",url:"https://abapi.testin.cn",expUrl:"/abtest-api/api/getexperiment",trackUrl:"/abtest-api/api/sendlog",errUrl:"/abtest-api/api/senderrorlog",packageName:"cn.testin.ab.weapp",sdkVersion:"v3.0.0",asyncTime:20,maxUploadCount:10}}(),function(){env={};try{var e=wx.getSystemInfoSync(),t=e.system.split(" "),n=e.language.split("_");env.os={name:t[0].toLocaleLowerCase(),version:t[1].toLocaleLowerCase()},env.language=n[0].toLocaleLowerCase(),env.country=n[1].toLocaleLowerCase(),env.weAppSDKVersion=e.SDKVersion,env.appVersion="_",env.device={screenWidth:e.screenWidth*e.pixelRatio,screenHeight:e.screenHeight*e.pixelRatio,model:e.model}}catch(e){env.os={},env.device={},env.language="",env.country="",env.weAppSDKVersion="",env.appVersion="_"}}(),ABTest.prototype={constructor:ABTest,init:function(e,t){var n=this;if(!e)throw new Error("appKey required");var o;try{o=wx.getStorageSync(config.storageKey)}catch(e){console.log(e)}if(!o||o.version!=config.localVersion){o=createLocalData();try{wx.setStorageSync(config.storageKey,o)}catch(e){console.log(e)}}t||(t=o.clientId),n._set("appKey",e),n._set("clientId",t),setUpAndDown(this)},setDefVars:function(e){var t=this._get("defVars"),n=this._get("varsData");for(var o in e)t[o]=e[o],n[o]=e[o]},setTags:function(e){var t={};for(var n in e)"string"==typeof e[n]?t[n]="'"+e[n]+"'":t[n]=e[n];this._set("tags",t)},setTimeout:function(e){return isNaN(e)||e<this._get("minTimeout")?this._set("timeout",this._get("minTimeout")):void this._set("timeout",e)},setUrl:function(e){"/"==e.substr(e.length-1)&&(e=e.substr(0,e.length-1)),this._set("url",e)},getVars:function(e){function t(t){r||(r=!0,setTimeout(function(){e&&e(t)},config.asyncTime))}var n={useCache:!0};if(e=e||function(){},!this._get("appKey"))throw new Error("è¯·å…ˆè°ƒç”¨initæ–¹æ³•è®¾ç½®appKey");var o=this,r=!1;this._get("localStorageSupported")?(setTimeout(function(){t(o._get("vars"))},this._get("timeout")),reqExp(this,t,n.useCache)):t(this._get("vars"))},getExperiments:function(e){function t(){setTimeout(function(){var t=n._get("data");t=t||{};for(var o=t.exps||[],r=[],a="CONTROL",s=0;s<o.length;s++){var i={layerId:o[s].layerId,layerName:o[s].layerName,expId:o[s].expId,expName:o[s].expName,expVersionId:o[s].componentsKey,expVersionName:o[s].expVersionName};o[s].componentsKey||(i.expId=a,i.expName=a,i.expVersionId=a,i.expVersionName=a),r.push(i)}e(r)},config.asyncTime)}var n=this;if(this._get("localStorageSupported"))if(this._get("dataLoaded"))t();else{var o=this._get("getExperimentsCallback");o.push(t)}else t()},track:function(){function e(){t&&(a||(a=!0,setTimeout(function(){t()},config.asyncTime)))}var t,n=arguments,o={};if("string"==typeof n[0]){if(!n[1]||"function"==typeof n[1])return;o[n[0]]=n[1],3==n.length&&(t=n[2])}else{for(var r in n[0])n[0][r]&&(o[r]=n[0][r]);2==n.length&&(t=n[1])}var a=!1;if(!this._get("localStorageSupported"))return e();if(!this._get("dataLoaded"))return e();setTimeout(function(){e()},this._get("timeout"));for(var s in o)reqPV(this,{opName:s});reqTrack(this,o,e)},getVersion:function(){return config.sdkVersion}},module.exports=new ABTest;
